version: '3.3'

services:
  frontend:
    build:
      context: .
      dockerfile: src/frontend/Dockerfile

      # https://github.com/docker/compose/issues/1837#issuecomment-316896858
      args:
        - STRAPI_PREVIEW_SECRET=${STRAPI_PREVIEW_SECRET}
        - API_URL=${API_URL}
        - WEB_URL=${WEB_URL}
    command: yarn dev
    volumes:
      - ./src/frontend:/usr/src/frontend
      - ./node_modules:/usr/src/frontend/node_modules
      - ./data/tiles/tiles.json:/usr/src/frontend/public/tiles.json
    environment:
      HTTPS_PROXY: https://proxy
  backend:
    build:
      context: .
      dockerfile: src/backend/Dockerfile
    command: yarn dev
    volumes:
      - ./src/backend:/usr/src/backend
      - ./node_modules:/usr/src/backend/node_modules
    ports:
      - "1337:1337"
  generator:
    build:
      context: src/generator/
    volumes:
      - ./data/tiles/:/usr/src/data/
      - ./src/generator/bin/Release/netcoreapp3.1/publish/:/usr/src/app
  proxy:
    build:
      context: src/proxy
      dockerfile: Dockerfile
    volumes:
      - ./src/proxy/nginx.dev.conf:/etc/nginx/conf.d/default.conf
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    # This was a pain!
    # Files get mounted as same id as WSL owner + nginx was failing silently to load SSL certs in mount
    # https://github.com/nginxinc/docker-nginx/pull/280#issuecomment-427963755
    user: "1000"
    networks:
      default:
        ipv4_address: 172.33.0.80
    extra_hosts:
      - "dev.rikk.it:172.33.0.80"
      - "api-dev.rikk.it:172.33.0.80"
  certbot:
    volumes:
      - ./data/.digitalocean.ini:/root/.digitalocean.ini
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
networks:
  default:
    ipam:
      driver: default
      config:
        - subnet: 172.33.0.0/16